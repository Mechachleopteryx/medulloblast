---
title: "gene_signatures"
author: "Kent Riemondy RBI"
date: "`r Sys.Date()`"
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "html") })
output:
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: false
    theme: cosmo
    highlight: tango
    fig_caption: true
    code_folding: hide
    df_print: paged
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libs}
source(here::here("/R/utils.R"))
library(ComplexHeatmap)
library(presto)
library(openxlsx)
library(gprofiler2)
library(ggrepel)

```


```{r}

so_fns <- file.path(obj_dir, c(
  file.path("shh", "shh.qs"),
  file.path("gp34", "gp3_only.qs"),
  file.path("gp34", "gp4_only.qs")))
                    
clusters <- c(
  "tumor_subpopulations_shh",
  "tumor_subpopulations_gp3",
  "tumor_subpopulations_gp4"
)

sos <- map(so_fns, 
            ~qread(.x, nthreads = 4, use_alt_rep = FALSE))

names(sos) <- c("SHH", "GP3", "GP4")

```

## Regenerate marker tables etc.

Using the new cell type labels

```{r}
all_mrkrs <- pmap(
  list(sos,
       names(sos),
       clusters
  ),
  function(so, id, cluster){
    
    mk_dir <- file.path(mkrs_dir, id)
    dir.create(mk_dir, showWarnings = FALSE)
    tbl_dir <- file.path(tbls_dir, id)
    dir.create(tbl_dir, showWarnings = FALSE)
    
    # markers
    full_mkrs <-  wilcoxauc(so, cluster) 
    
    mkrs <- filter(full_mkrs, logFC > 0, padj < 0.05, pct_in > 0.10) %>% 
      group_by(group) %>% 
      arrange(padj, desc(logFC), .by_group = TRUE)
    
    mkrs %>% 
      write_tsv(file.path(mk_dir, str_c("harmony_subpopulation_markers_", id, ".tsv")))
    
    mkrs %>% 
      ungroup() %>% 
      split(., .$group) %>% 
      write_markers_xlsx(., file.path(tbl_dir,
                                      str_c("harmony_subpopulation_markers_", id, ".xlsx")))
    
    # Go terms using top 500 markers 
    mkrs <- mkrs %>% 
      group_by(group) %>% 
      slice(1:500)  
    
    mkrs_split <- split(mkrs, mkrs$group) %>% 
      map(~pull(.x, feature))
    
    go_res <- gost(mkrs_split, 
                   ordered_query = TRUE,
                   sources = c("GO", 
                               "KEGG", 
                               "REAC", 
                               "TF"))
    
    go_res[["result"]] %>% 
      mutate(parents = unlist(map(parents, ~str_c(.x, collapse = ",")))) %>% 
      write_tsv(., file.path(tbl_dir, str_c("subpopulation_goterms_", id, ".tsv")))
    
    go_res[["result"]] %>% 
      mutate(parents = unlist(map(parents, ~str_c(.x, collapse = ","))),
             source = str_replace_all(source, "[[:punct:]]", " ")) %>% 
      select(-significant) %>% 
      split(., .$query) %>% 
      openxlsx::write.xlsx(., file.path(tbl_dir, 
                                        str_c("subpopulation_goterms_", id, ".xlsx")))
    
    ## Average Expression
    write_avg_expr(so,  
                   cluster,
                   file.path(tbl_dir, 
                             str_c("subpopulation_avgexpr_", id, ".csv")))
    ## Cell counts
    cell_count_mat <- get_cell_count_matrix(so, "UPN", cluster)
    cell_count_mat[is.na(cell_count_mat)] <- 0L
    cell_count_mat %>% 
      tibble::rownames_to_column("UPN") %>% 
      write_csv(file.path(tbl_dir, 
                          str_c("subpopulation_cell_counts_", id, ".csv")))
    
    ## marker matrix 
    full_marker_matrix <- full_mkrs %>%  top_marker_matrix(.) 
    
    topn_marker_matrix <- full_mkrs %>% top_marker_matrix(n = 200) 
    
    out <- list(avg_expression = read_csv(file.path(tbl_dir, 
                                                    str_c("subpopulation_avgexpr_", 
                                                          id,
                                                          ".csv"))),
                logFC_all = full_marker_matrix,
                top_200_logFC = topn_marker_matrix)
    
    openxlsx::write.xlsx(out, 
                         file.path(tbl_dir, 
                                   str_c("subpopulation_expression_logfc_summaries_",
                                         id,
                                         ".xlsx")))
    
    #full count matrix
    GetAssayData(so, "counts") %>% 
      as.matrix(.) %>% 
      as.data.frame() %>% 
      rownames_to_column("gene") %>% 
      data.table::fwrite(., file.path(tbl_dir, str_c(id, 
                                                     "_count_matrix.csv.gz")),
                         sep = ",",
                         compress = "gzip")
    
    # expression matrix filtered at least 25 cells express the gene
    expr_mat <- GetAssayData(so, "data")
    expr_mat <- expr_mat[Matrix::rowSums(expr_mat > 0) >= 25, ]
    
    expr_mat %>% 
      as.matrix(.) %>% 
      as.data.frame() %>% 
      rownames_to_column("gene") %>% 
      data.table::fwrite(., file.path(tbl_dir, str_c(id, "_expr_matrix.csv.gz")),
                         sep = ",",
                         compress = "gzip")
    
    ## TF markers
    Idents(so) <- cluster
    DefaultAssay(so) <- "TF"
    
    so_tf_markers <- wilcoxauc(so,
                               group_by = cluster, 
                               seurat_assay = "TF") %>% 
      filter(logFC > 0, 
             padj < 0.05) %>% 
      group_by(group) %>% 
      arrange(padj, desc(logFC))
    
    write_tsv(so_tf_markers, file.path(tbl_dir, 
                                       str_c("subpopulation_tf_activities_", id, ".tsv")))
    
    write_markers_xlsx(split(so_tf_markers, so_tf_markers$group),
                       path = file.path(tbl_dir, 
                                        str_c("subpopulation_tf_activities_", id, ".xlsx")),
                       description_string = "Transcription factor regulons derived from PyScenic that are significantly enriched in each cluster")
    
    mkrs
  })


```

```{r}

rmd_dir <- "cell_type_signature_comparisons"

fig_dir <- file.path(fig_dir, rmd_dir)
mkrs_dir <- file.path(mkrs_dir, rmd_dir)
tbls_dir <- file.path(tbls_dir, rmd_dir)
go_dir <- file.path(tbls_dir, "go")
xcel_markers_dir <- file.path(tbls_dir, "markers")

walk(c(fig_dir, mkrs_dir, tbls_dir, go_dir, xcel_markers_dir),
     dir.create, 
     showWarnings = FALSE)
```


```{r}
sos <- pmap(
  list(sos,
    names(sos),
    clusters),
            function(so, id, cluster){
              # drop the excluded populations
              to_keep <- rownames(so@meta.data)[!str_detect(so[[cluster]][,1], "-X[0-9]$")]
              so <- subset(so, cells = to_keep)
              so$tumor_cell_type <- so[[cluster]][,1]
              so
            })

avg_expr <- pmap(list(
  sos,
  names(sos),
  clusters),
           function(x, id, cluster){
            Idents(x) <- "tumor_cell_type"
             mat <- AverageExpression(x)$RNA
             x <- FindVariableFeatures(x, nfeatures = 2000)
             var_genes <- VariableFeatures(x)
             list(expr = mat,
                  var_genes = var_genes)
           })


var_genes <- map(avg_expr, ~.x$var_genes) %>% 
  unlist() %>% 
  unique()

avg_expr_mat <- map(avg_expr, ~.x$expr) %>% 
  unname() %>% 
  do.call(cbind, .)

avg_expr_mat <- avg_expr_mat[var_genes, ]


hmap <- Heatmap(cor(avg_expr_mat, method = "pearson"),
        col = viridis::viridis(256),
        name = "Correlation",
        row_names_gp = gpar(fontsize = 7),
        column_names_gp = gpar(fontsize = 7))

pdf(file.path(fig_dir, "tumor_subpopulation_correlation_matrix.pdf"),
    width = 9,
    height = 7)
draw(hmap)
dev.off()

hmap
```


```{r}
so <- merge(sos[[1]], sos[2:3])
```


```{r}
var_marker_lst <- all_mrkrs %>%
  map(~group_by(.x, group) %>% slice(1:100)) %>% 
  bind_rows() %>% 
  split(., .$group) %>% 
  map(~pull(.x, feature))

var_marker_lst <- var_marker_lst[!str_detect(names(var_marker_lst),  "-X[0-9]$")]


for(i in seq_along(var_marker_lst)){
  mrks <- var_marker_lst[[i]]
  id <- names(var_marker_lst)[i]
  so <- AddModuleScore(so, list(x = mrks), assay = "RNA", name = id, seed = 42)
}

# rename cols
col_idxs <- match(str_c(make.names(names(var_marker_lst)), "1"), 
                    colnames(so@meta.data))
colnames(so@meta.data)[col_idxs] <- str_c(names(var_marker_lst), "-signature")

all_tumor_cell_expression_scores <- get_metadata(so, embedding = NULL) %>% 
  .[, c("cell", str_c(names(var_marker_lst), "-signature"))] %>% 
  column_to_rownames("cell") %>% 
  as.matrix()

hmap <- Heatmap(cor(all_tumor_cell_expression_scores, method = "spearman"),
         col = viridis::viridis(256),
        name = "Correlation",
        row_names_gp = gpar(fontsize = 7),
        column_names_gp = gpar(fontsize = 7))

pdf(file.path(fig_dir, "tumor_subpopulation_scores_all_tumor_cells_cor_matrix.pdf"),
    width = 9,
    height = 7)
  draw(hmap)
dev.off()

hmap
```



##

```{r, eval = FALSE}
all_tumor_mkrs <- wilcoxauc(so, "tumor_cell_type")

undiff_pops <- str_subset(unique(so$tumor_cell_type), "_Undifferentiated")
undiff_mkrs <- wilcoxauc(so, "tumor_cell_type", groups_use = undiff_pops)

top_undiff_mkrs <- undiff_mkrs %>% 
  filter(padj < 0.05,
                       logFC > 0, 
                       pct_in > 0.10) %>% 
  group_by(group) %>% 
  arrange(padj, desc(logFC), .by_group = T) %>% 
  ungroup()


diff_pops <- str_subset(unique(so$tumor_cell_type), "_Differentiated")
diff_mkrs <- wilcoxauc(so, "tumor_cell_type", groups_use = diff_pops)

top_diff_mkrs <- diff_mkrs %>% 
  filter(padj < 0.05,
                       logFC > 0, 
                       pct_in > 0.10) %>% 
  group_by(group) %>% 
  arrange(padj, desc(logFC), .by_group = T) %>% 
  ungroup()

top_diff_mkrs <- split(top_diff_mkrs, top_diff_mkrs$group) 
names(top_diff_mkrs) <- names(top_diff_mkrs) %>% 
   str_remove("_Differentiated") %>% 
  str_replace_all("[[:punct:]]", "")

write.xlsx(top_diff_mkrs, file.path(xcel_markers_dir,
                                    "tumor_differentiated_population_markers.xlsx")) 

top_undiff_mkrs <- split(top_undiff_mkrs, top_undiff_mkrs$group) 
names(top_undiff_mkrs) <- names(top_undiff_mkrs) %>% 
   str_remove("_Undifferentiated") %>% 
  str_replace_all("[[:punct:]]", "")

write.xlsx(top_undiff_mkrs, file.path(xcel_markers_dir,
                                    "tumor_undifferentiated_population_markers.xlsx")) 
```


```{r, eval = FALSE}
# Use top 500 markers   
mkrs_split <- map(top_undiff_mkrs, ~pull(.x[1:500, ], feature))

go_res <- gost(mkrs_split, 
               ordered_query = TRUE,
               sources = c("GO", 
                          "KEGG", 
                          "REAC", 
                          "TF"))

go_res[["result"]] %>% 
  mutate(parents = unlist(map(parents, ~str_c(.x, collapse = ","))),
         source = str_replace_all(source, "[[:punct:]]", " ")) %>% 
  select(-significant) %>% 
  split(., .$query) %>% 
  openxlsx::write.xlsx(., file.path(go_dir, "goterms_undifferentiated_cell_types.xlsx"))



mkrs_split <- map(top_diff_mkrs, ~pull(.x[1:500, ], feature))

go_res <- gost(mkrs_split, 
               ordered_query = TRUE,
               sources = c("GO", 
                          "KEGG", 
                          "REAC", 
                          "TF"))

go_res[["result"]] %>% 
  mutate(parents = unlist(map(parents, ~str_c(.x, collapse = ","))),
         source = str_replace_all(source, "[[:punct:]]", " ")) %>% 
  select(-significant) %>% 
  split(., .$query) %>% 
  openxlsx::write.xlsx(., file.path(go_dir, "goterms_differentiated_cell_types.xlsx"))
```

```{r, eval = FALSE}
mkrs <- diff_mkrs %>% 
  filter(padj < 0.05,
         logFC > 0, 
         pct_in > 0.10) %>% 
  group_by(group) %>% 
  arrange(padj, desc(logFC), .by_group = T) %>% 
  # mutate(group = factor(group, levels = ))
  slice(1:10) %>% 
  pull(feature)

tmp <- subset(so, 
              subset = tumor_cell_type %in% c(
                "SHH_Differentiated (GRIA2, GOLGA8A, MALAT1) #1",
                "SHH_Differentiated (STMN2/4, MLLT1, NHLH1/2) #4",
                "GP3_Differentiated (GOLGA8A, MALAT1) #0",
                "GP3_Differentiated Photoreceptor (NRL) #2",
                "GP4_Differentiated (GRIA2, GOLGA8A, MALAT1) #0",
                "GP4_Differentiated Photoreceptor (NRL) #5")
)

tmp@assays$TF <- NULL
tmp <- ScaleData(tmp, features = mkrs)

hmap <- plot_heatmap(tmp, 
             features = unique(mkrs),
             group = "tumor_cell_type",
             average = TRUE, 
             hmap_options = list(show_column_names = FALSE, 
                                 cluster_columns = TRUE,
                                 cluster_rows = FALSE)
    )

pdf(file.path(fig_dir, "top_markers_between_differentiated_populations.pdf"),
    width = 7,
    height = 9)
draw(hmap)
dev.off()

hmap



mkrs <- undiff_mkrs %>% 
  filter(padj < 0.05,
                       logFC > 0, 
                       pct_in > 0.10) %>% 
  group_by(group) %>% 
  arrange(padj, desc(logFC), .by_group = T) %>% 
 # mutate(group = factor(group, levels = ))
  slice(1:10) %>% 
  pull(feature)

tmp <- subset(so, 
              subset = tumor_cell_type %in% c(
                "SHH_Undifferentiated (RPGs and SFRP1) #0",
                "SHH_Undifferentiated (RPGs and BTF3) #2",
                "GP3_Undifferentiated (RPGs and BTF3) #1",
                "GP3_Undifferentiated (MYC, FOXQ1/F2) #4",
                "GP4_Undifferentiated (RPGs, STMN1/2, EOMES) #1",
                "GP4_Undifferentiated (RPGs, STMN1/2) #2")
)

tmp@assays$TF <- NULL
tmp <- ScaleData(tmp, features = mkrs)

hmap <- plot_heatmap(tmp, 
             features = unique(mkrs),
             group = "tumor_cell_type",
             average = TRUE, 
             hmap_options = list(show_column_names = FALSE, 
                                 cluster_columns = TRUE,
                                 cluster_rows = TRUE)
    )

pdf(file.path(fig_dir, "top_markers_between_progenitor_populations.pdf"),
    width = 7,
    height = 9)
draw(hmap)
dev.off()

hmap

```


### Cell cycle differences

```{r, eval = FALSE}
plts <- plot_feature(sos$GP4, c("tumor_cell_type", 
                        "Phase",
                        "MKI67",
                        "GRIA2",
                        "RPL32"),
             embedding = "pca")

p <- plot_grid(plotlist = plts[2:5],
  nrow = 2, 
  ncol = 2)

p

save_plot(file.path(fig_dir, "gp4_cell_cycle_pca.pdf"),
          p,
          nrow = 2,
          ncol = 2,
          base_asp = 1.5)

p <- plot_grid(plotlist = plts[1],
  nrow = 1, 
  ncol = 1)

p

save_plot(file.path(fig_dir, "gp4_cell_type_pca.pdf"),
          p,
          nrow = 1,
          ncol = 1,
          base_asp = 2.5)


p <- plot_harmony(sos$GP4, "tumor_cell_type", legend_title = "")

save_plot(file.path(fig_dir, "gp4_cell_type_umap.pdf"),
          p,
          base_asp = 2.5)
```


```{r, eval = FALSE}

plts <- plot_feature(sos$GP3, c("tumor_cell_type", 
                        "Phase",
                        "MKI67",
                        "PCDH9",
                        "RPL32"),
             embedding = "pca")

p <- plot_grid(plotlist = plts[2:5],
  nrow = 2, 
  ncol = 2)

p

save_plot(file.path(fig_dir, "gp3_cell_cycle_pca.pdf"),
          p,
          nrow = 2,
          ncol = 2,
          base_asp = 1.5)

p <- plot_grid(plotlist = plts[1],
  nrow = 1, 
  ncol = 1)

p

save_plot(file.path(fig_dir, "gp3_cell_type_pca.pdf"),
          p,
          nrow = 1,
          ncol = 1,
          base_asp = 2.5)

p <- plot_harmony(sos$GP3, "tumor_cell_type", legend_title = "")

save_plot(file.path(fig_dir, "gp3_cell_type_umap.pdf"),
          p,
          base_asp = 2.5)
```



```{r, eval = FALSE}

plts <- plot_feature(sos$SHH, c("tumor_cell_type", 
                        "Phase",
                        "MKI67",
                        "NHLH1",
                        "RPL32"),
             embedding = "pca")

p <- plot_grid(plotlist = plts[2:5],
  nrow = 2, 
  ncol = 2)

p

save_plot(file.path(fig_dir, "shh_cell_cycle_pca.pdf"),
          p,
          nrow = 2,
          ncol = 2,
          base_asp = 1.5)

p <- plot_grid(plotlist = plts[1],
  nrow = 1, 
  ncol = 1)

p

save_plot(file.path(fig_dir, "shh_cell_type_pca.pdf"),
          p,
          nrow = 1,
          ncol = 1,
          base_asp = 2.5)


p <- plot_harmony(sos$SHH, "tumor_cell_type", legend_title = "")

save_plot(file.path(fig_dir, "shh_cell_type_umap.pdf"),
          p,
          base_asp = 2.5)
```

