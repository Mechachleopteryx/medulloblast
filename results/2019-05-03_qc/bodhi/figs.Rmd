---
title: "Generate Figures"
author: "Kent Riemondy RBI"
date: "`R Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: false
    fig_caption: yes
    fig_retina: 1 
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message=FALSE)
knitr::opts_chunk$set(cache.lazy = FALSE)
```


```{r libs, warning=FALSE, echo=FALSE}
source("../../R/utils.R")
library(future)
plan(strategy = "multicore", workers = 16)
options(future.globals.maxSize = 10 * 1024 ^ 3)

proj_dir <- here()
data_dir <- file.path(proj_dir, "data", "cellranger", "results")
doc_dir <- file.path(proj_dir, "docs")

reticulate::use_python("/cluster/software/modules-python/python/3.6.3/bin/python3",
                       required = TRUE)
```

# Experiment Summary


```{r get_data}

# read in metadata to parse out directories and sample ids
mdata <- read_excel(file.path(doc_dir, 
                                   "MED scRNAseq batch and annotations 5.8.19.xlsx"))
sample_paths <- file.path(data_dir,
                          mdata$fq_id,
                          "outs", 
                          "filtered_feature_bc_matrix")

names(sample_paths) <- str_replace(mdata$UPN, "_", "-")

mat <- Read10X(sample_paths)
```


## General QC for library prep  {.tabset}

```{r }

metrics_paths <- file.path(data_dir,
                          mdata$fq_id,
                          "outs", 
                          "metrics_summary.csv")

names(metrics_paths) <- mdata$UPN

mapping_dat <- map_dfr(metrics_paths, read_csv, .id = "sample")

clean_up_metadata <- function(metrics_summary) {
  metrics_summary <- mutate_all(metrics_summary, str_remove, "%$")
  metrics_summary <- mutate_at(metrics_summary, .vars = 2:ncol(metrics_summary), as.numeric)
  metrics_summary
}

mapping_dat <- clean_up_metadata(mapping_dat)

metrics <- colnames(mapping_dat)[2:ncol(mapping_dat)]

mapping_dat <- mapping_dat %>% 
  gather(metric, value, -sample) %>% 
  left_join(mdata, by = c("sample" = "UPN")) %>% 
  arrange(subgroup) %>% 
  mutate(sample = factor(sample, levels = unique(sample)))

p <- map(metrics, 
    function(x) {
    filter(mapping_dat, metric == x) %>% 
          ggplot(aes(sample, value)) +
            geom_point(aes(color = subgroup)) +
        scale_color_brewer(palette = "Paired") + 
        labs(y = x, 
             x = "") +
        theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
}) 
```

```{r, results ='asis'}

for(i in seq_along(p)){
  cat('\n### ', metrics[i], '\n')
  print(p[i])
  cat('\n')
}
```


## Preprocessing {.tabset}

```{r create_seurat, message = F, results = 'hide', warning = F}

sobj <- CreateSeuratObject(mat, 
                             min.cells = 3, 
                             min.features = 200,
                             names.delim = "_", 
                             names.field = 1)

# fix 966-2 to 966_2 
sobj@meta.data$orig.ident <- str_replace(sobj@meta.data$orig.ident, "966-2", "966_2")

sobj <- PercentageFeatureSet(sobj, pattern = "^MT-", col.name = "percent.mt")

sobj@meta.data <- sobj@meta.data %>% 
  tibble::rownames_to_column("cell") %>% 
  left_join(mdata, by = c("orig.ident" = "UPN")) %>% 
  mutate(UPN = orig.ident) %>% 
  as.data.frame() %>% 
  tibble::column_to_rownames("cell")
  
```

### Percent Mitochondrial UMIs 

```{r}
plot_violin(sobj@meta.data, "orig.ident", "percent.mt", .fill = "subgroup") +
  labs(x = "", y = "Percent UMIs from Mitochondria")
```


### # of genes detected 

```{r}
plot_violin(sobj@meta.data, "orig.ident", "nFeature_RNA", .fill = "subgroup") +
  labs(x = "", y = "# of genes per cell")
```


### # of UMIs detected

```{r}
plot_violin(sobj@meta.data, "orig.ident", "nCount_RNA", .fill = "subgroup") +
  labs(x = "", y = "# of UMIs") +
  scale_y_log10()
```

### Table of mitochondrial proportions per sample

```{r}
sobj@meta.data %>% 
  group_by(UPN) %>% 
  summarize(median_percent_mito = median(percent.mt), 
            mean_percent_mito = mean(percent.mt)) %>% 
  arrange(desc(median_percent_mito))

```


## Relationship between UMIs and % mitochondria {.tabset}

### All samples
```{r, fig.wight = 24, fig.height = 18}
p <- list()
sample_names <- as.character(unique(sobj@meta.data$orig.ident))
per_sample <- map(sample_names, ~filter(sobj@meta.data, 
                                        orig.ident == .x))

for(i in seq_along(per_sample)){
  .col <- discrete_palette_default[i]
  p[[i]] <- ggplot(per_sample[[i]], aes(nCount_RNA, percent.mt)) +
        geom_point(aes(color = UPN)) +
        scale_color_manual(values = .col)
}

plot_grid(plotlist= p, nrow = 5, ncol = 7)
```

```{r, results ='asis'}



# generate tab with individual plot programmatically 
# see https://stackoverflow.com/questions/43752095/programmatically-insert-header-and-plot-in-same-code-chunk-with-r-markdown-using?noredirect=1&lq=1

for(i in seq_along(per_sample)){
  .col <- discrete_palette_default[i]
  cat('\n### ', sample_names[i], '\n')
  p <- ggplot(per_sample[[i]], aes(nCount_RNA, percent.mt)) +
        geom_point(aes(color = UPN)) +
        scale_color_manual(values = .col)
  print(p)
  cat('\n')
}
```


## Filter cells and samples.

Suggest removing cells with > 35% mitochondrial UMIs

```{r}
sobj <- subset(sobj, subset = percent.mt < 35)
```

## Normalize and embed into 2D with UMAP
```{r}

sobj <- NormalizeData(sobj, verbose = FALSE)
sobj <- FindVariableFeatures(sobj, 
                             selection.method = "vst", 
                             nfeatures = 3000, 
                             verbose = FALSE)

sobj <- ScaleData(sobj, 
                  vars.to.regress = c("percent.mt", "nCount_RNA"), 
                  verbose = TRUE)

sobj <- RunPCA(sobj, npcs = 40, verbose = FALSE)
sobj <- RunUMAP(sobj, reduction = "pca", 
                dims = 1:40, min.dist = 0.4, n.neighbors = 50L)
```


```{r}
p <- plot_umap(sobj, "UPN", pt_alpha = 0.75)
p
save_plot("umap_by_sample.pdf", p, base_asp = 1.75)

p <- plot_umap(sobj, "subgroup", pt_alpha = 0.75)
p
save_plot("umap_by_subgroup.pdf", p, base_asp = 1.75)
```


```{r, fig.width = 24, fig.height = 18}

genes <- c(
  'CD3D',
  'PSAP',
  'TOP2A',
  'MYCN',
  'OTX2',
  'CDK6',
  'ACVR1',
  'GFI1B',
  'TERT',
  'SNCAIP',
  'GLI2',
  'YAP1' )


p <- map(genes, ~plot_umap(sobj, .x))

p <- plot_grid(plotlist = p, ncol = 4, nrow = 3)

save_plot("umap_genes.pdf", p, base_asp = 1.5, ncol = 4, nrow = 3)

p
```

## save unmerged object
```{r}
saveRDS(sobj, "sobj.rds")
sobj <- readRDS("sobj.rds")
```

```{r}
sobjs <- SplitObject(sobj, "UPN")

sobjs <- map(sobjs, function(sobj){
  sobj <- NormalizeData(sobj, verbose = FALSE)
  sobj <- FindVariableFeatures(sobj, selection.method = "vst", nfeatures = 3000, 
        verbose = FALSE)
  sobj
})


anchors <- FindIntegrationAnchors(sobjs, dims = 1:40)

sobj_int <- IntegrateData(anchors, dims = 1:40)

DefaultAssay(sobj_int) <- "integrated"
saveRDS(sobj_int, "sobj_int.rds")
```

```{r eval = FALSE}
# sobj_int <- ScaleData(sobj_int, 
#                       vars.to.regress = c("nUMI_features", "percent.mt"),
#                       verbose = FALSE)
# sobj_int <- RunPCA(sobj_int, npcs = 40)
# sobj_int <- RunUMAP(sobj_int, reduction = "pca", dims = 1:40)

```
