---
title: "3_mouse_model_comparison.Rmd"
author: "Kent Riemondy RBI"
date: "9/3/2019"
output: html_document
---

```{r libs, message=FALSE, warning=FALSE, echo=FALSE}
source("../R/utils.R")
library(openxlsx)
library(future)
plan(strategy = "multicore", workers = 7)
options(future.globals.maxSize = 4 * 1024 ^ 3)

proj_dir <- here()
data_dir <- file.path(proj_dir, "data", "cellranger", "results")
doc_dir <- file.path(proj_dir, "docs")

fig_dir <- file.path("figs", "mouse_models")
mkrs_dir <- file.path("markers", "mouse_models")
tbls_dir <- file.path("tables", "mouse_models")
mkrs_tsv_dir <- file.path(mkrs_dir, "tsv")
mkrs_xlsx_dr <- file.path(mkrs_dir, "xlsx")

walk(c(fig_dir,
       mkrs_dir,
       tbls_dir,
       mkrs_tsv_dir,
       mkrs_xlsx_dr), dir.create, showWarnings = F)

```

# Get ortholog table

Download list of orthologs between mouse and human as gene symbols.

```{r}
ortholog_table <- "../dbases/mouse_orthologs.tsv"

if(!file.exists(ortholog_table)){
  library(biomaRt)
  ensembl <- useMart("ensembl", dataset = "hsapiens_gene_ensembl")
  
  orthologs <- getBM(mart = ensembl, 
      attributes = c("external_gene_name",
                     "mmusculus_homolog_associated_gene_name"))
  
  write_tsv(orthologs, ortholog_table)
}

orthologs <- read_tsv(ortholog_table)
```

# SHH mouse model

## Preprocess
```{r get_data}
samples <- c(
  "MED9_1",
  "MED11_2",
  "MED21_3"
)
sample_paths <- file.path(data_dir,
                          samples,
                          "outs", 
                          "filtered_feature_bc_matrix")

names(sample_paths) <- samples

mat <- Read10X(sample_paths)
```


### General QC for library prep  {.tabset}

```{r }

metrics_paths <- file.path(data_dir,
                          samples,
                          "outs", 
                          "metrics_summary.csv")

names(metrics_paths) <- samples

mapping_dat <- map_dfr(metrics_paths, read_csv, .id = "sample")

clean_up_metadata <- function(metrics_summary) {
  metrics_summary <- mutate_all(metrics_summary, str_remove, "%$")
  metrics_summary <- mutate_at(metrics_summary, 
                               .vars = 2:ncol(metrics_summary),
                               as.numeric)
  metrics_summary
}

mapping_dat <- clean_up_metadata(mapping_dat)

metrics <- colnames(mapping_dat)[2:ncol(mapping_dat)]

mapping_dat <- mapping_dat %>% 
  gather(metric, value, -sample) %>% 
  mutate(sample = factor(sample, levels = unique(sample)))

p <- map(metrics, 
    function(x) {
    filter(mapping_dat, metric == x) %>% 
          ggplot(aes(sample, value)) +
            geom_point(aes(color = sample)) +
        scale_color_brewer(palette = "Paired") + 
        labs(y = x, 
             x = "") +
        theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
}) 
```

```{r, results ='asis'}

for(i in seq_along(p)){
  cat('\n### ', metrics[i], '\n')
  print(p[i])
  cat('\n')
}
```


## Preprocessing {.tabset}

```{r create_seurat, message = F, results = 'hide', warning = F}

so <- CreateSeuratObject(
  mat,
  min.cells = 3,
  min.features = 200,
  names.delim = "_",
  names.field = c(1, 2)
)

so <- PercentageFeatureSet(so, pattern = "^mt-", col.name = "percent.mt")

so@meta.data <- so@meta.data %>% 
  tibble::rownames_to_column("cell") %>% 
  mutate(UPN = orig.ident) %>% 
  as.data.frame() %>% 
  tibble::column_to_rownames("cell")

dir.create(file.path("objects",
                     "mouse_models"),
           showWarnings = FALSE)

rm(mat)
a <- gc()
```

### Percent Mitochondrial UMIs 

```{r}
plot_violin(so@meta.data, "orig.ident", "percent.mt", .fill = "orig.ident") +
  labs(x = "", y = "Percent UMIs from Mitochondria")
```


### # of genes detected 

```{r}
plot_violin(so@meta.data, "orig.ident", "nFeature_RNA", .fill = "orig.ident") +
  labs(x = "", y = "# of genes per cell")
```


### # of UMIs detected

```{r}
plot_violin(so@meta.data, "orig.ident", "nCount_RNA", .fill = "orig.ident") +
  labs(x = "", y = "# of UMIs") 
```

### Table of mitochondrial proportions per sample

```{r}
so@meta.data %>% 
  group_by(UPN) %>% 
  summarize(median_percent_mito = median(percent.mt), 
            mean_percent_mito = mean(percent.mt)) %>% 
  arrange(desc(median_percent_mito))

```


## Relationship between UMIs and % mitochondria {.tabset}

### All samples
```{r, fig.width = 12, fig.height = 8}
sample_names <- as.character(unique(so@meta.data$orig.ident))
per_sample <- map(sample_names, ~filter(so@meta.data, 
                                        orig.ident == .x))
p <- list()
for(i in seq_along(per_sample)){
  .col <- discrete_palette_default[i]
  p[[i]] <- ggplot(per_sample[[i]], aes(nCount_RNA, percent.mt)) +
        geom_point(aes(color = UPN)) +
        scale_color_manual(values = .col)
}

plot_grid(plotlist= p, nrow = 1, ncol = 3)
```

```{r, results ='asis'}

for(i in seq_along(per_sample)){
  .col <- discrete_palette_default[i]
  cat('\n### ', sample_names[i], '\n')
  p <- ggplot(per_sample[[i]], aes(nCount_RNA, percent.mt)) +
        geom_point(aes(color = UPN)) +
        scale_color_manual(values = .col)
  print(p)
  cat('\n')
}
```


## Filter cells and samples.

Suggest removing cells with > 20% mitochondrial UMIs. 

```{r}
so <- subset(so, subset = percent.mt < 20)
```

## Normalize and embed into 2D with UMAP

```{r}
so <- NormalizeData(so, verbose = FALSE)

so <- FindVariableFeatures(so, 
                           selection.method = "vst", 
                           nfeatures = 3000, 
                           verbose = FALSE)

so <- ScaleData(so, 
                verbose = TRUE)

so <- RunPCA(so, npcs = 40, verbose = FALSE)

ElbowPlot(so, ndims = 40)

so <- FindNeighbors(so, 
                    reduction = "pca", 
                    dims = 1:30)

so <- RunUMAP(so, 
              graph = "RNA_snn", 
              min.dist = 0.3
)

plts <- list()
plts[[1]] <- plot_feature(so, "orig.ident", embedding = "umap") 
plts[[2]] <- plot_features_split(so, 
                                 "orig.ident", "orig.ident", 
                                 embedding = "umap",
                                 cols = discrete_palette_default)

plts[[1]]

plts[[2]]
```

```{r}
so <- FindClusters(so, resolution = 0.32)

so$clusters<- so$seurat_clusters
so$seurat_clusters <- NULL
so$RNA_snn_res.0.32 <- NULL

plts <- list()
plts[[1]] <- plot_feature(so, "clusters", embedding = "umap") + 
  guides(color = guide_legend(ncol = 2,
                              override.aes = list(size = 4))) + 
  labs(title = "All samples")
plts[[2]] <- plot_features_split(so, 
                                 "clusters", 
                                 "orig.ident",
                                 embedding = "umap", add_title = TRUE)

plts


```

Add cell cycle stage

```{r, fig.width = 12}

s_genes_mouse <- inner_join(tibble(gene = cc.genes$s.genes),
                            orthologs, 
                            by = c("gene" = "external_gene_name")) %>% pull(mmusculus_homolog_associated_gene_name)

g2m_genes_mouse <- inner_join(tibble(gene = cc.genes$s.genes),
                            orthologs, 
                            by = c("gene" = "external_gene_name")) %>% pull(mmusculus_homolog_associated_gene_name)

so <- CellCycleScoring(so,
                       s_genes_mouse,
                       g2m_genes_mouse)

cc_scores <- c(
  "Pola1",
  "Mcm2",
  "Mki67",
  "Phase",
  "S.Score",
  "G2M.Score"
)

plts <- map(cc_scores,
            ~plot_umap(so, 
                       .x, 
                       show_negative = TRUE))
plt <- plot_grid(plotlist = plts, nrow = 2,
                 ncol = 3)
plt

```


Assign cell_types with clustifyr

```{r}
library(clustifyr)
library(ComplexHeatmap)

tm_average <- readRDS("/Users/kriemo/Projects/sc_repos/vanotterloo/data/tabula_muris/TM_avg_expr.rds")

mdata <- get_metadata(so)

res <- clustify(so@assays$RNA@data, 
                tm_average, 
                query_genes = so@assays$RNA@var.features,
                metadata = mdata, 
                cluster_col = "clusters", 
                compute_method = "spearman")

hmap <- Heatmap(t(res), 
                viridis::viridis(256), 
                "Spearman\ncorrelation",
                row_title = "Cell types from Tabula Muris",
                column_title = "Clusters")

hmap

top_cell_types <- cor_to_call(res, threshold = 0.5)

so@meta.data <- so@meta.data %>% 
  tibble::rownames_to_column("cell") %>% 
  left_join(top_cell_types, 
            by = c("clusters" = "cluster")) %>% 
  dplyr::rename(tabula_muris_cell_type = type,
                cor_value = r) %>% 
  tibble::column_to_rownames("cell")
```

```{r}
map(c("clusters", "tabula_muris_cell_type"), 
    ~plot_umap(so, .x, label_text = TRUE, 
               label_col = "black")) 
```
#### Save object

```{r}
saveRDS(so, file.path("objects",
                  "mouse_models",
                  "shh_model_sobj.rds"))
```
#### Get markers

```{r}
so <- readRDS(file.path("objects",
                  "mouse_models",
                  "shh_model_sobj.rds"))

Idents(so) <- "clusters"
mkrs <- FindAllMarkers(so, only.pos = TRUE)


write_tsv(mkrs, 
          file.path(mkrs_tsv_dir, "shh_cluster_markers.tsv"))

mkrs_list <- split(mkrs, mkrs$cluster)

write_markers_xlsx(mkrs_list, 
           file.path(mkrs_xlsx_dr,
                     "shh_cluster_markers.xlsx"))
```


### fix cell type assignments


```{r}
new_ids <- c(
  '0' = "endothelial",
  '5' = "macrophages",
  '6' = "fibroblasts", # second most correlated cell type
  '7' = "neuroendocrine", # second most correlated cell type
  '9' = "oligodendrocytes", #olig1 expression
  '10' = "monocytes",
  '11' = "astroglia", # Mlc1 expression
  '1' = "malignant",
  '2' = "malignant",
  '3' = "malignant",
  '4' = "malignant",
  '8' = "malignant",
  '12' = "malignant"
)


so@meta.data$cell_types <- new_ids[so@meta.data$clusters]

map(c("clusters", "cell_types"), 
    ~plot_umap(so, .x, label_text = TRUE, 
               label_col = "black")) 

```

### Write out metadata


```{r} 
mdata_out <- get_metadata(so)
outname <- file.path("tables", 
                     paste0("shh_metadata_", 
                            format(Sys.Date(), "%Y_%m_%d"), 
                            ".tsv.gz"))
write_tsv(mdata_out, outname)

saveRDS(so, file.path("objects",
                  "mouse_models",
                  "shh_model_sobj.rds"))
```

## Add in Northcutt paper metamodule scores

```{r}
so <- readRDS(file.path("objects",
                  "mouse_models",
                  "shh_model_sobj.rds"))

if(!file.exists("../docs/northcutt_sup_tbl_2.xlsx")){
  supp_tbl_2 <- "https://static-content.springer.com/esm/art%3A10.1038%2Fs41586-019-1434-6/MediaObjects/41586_2019_1434_MOESM3_ESM.xlsx"

  download.file(supp_tbl_2, "../docs/northcutt_sup_tbl_2.xlsx")
}

sup_tbl <- read_excel("../docs/northcutt_sup_tbl_2.xlsx", 
           sheet = 2,
           skip = 3) 

sup_tbl[, 1] <- NULL

# extract out each metaprogram following their approach of excluding ribosomal
# and protein genes and non-coding RNAs

mps <- map(seq(1, ncol(sup_tbl), 2), 
    ~c(.x, .x + 1)) %>% 
  map(., ~sup_tbl[, .x] 
      %>% na.omit()) 

mp_names <- map_chr(mps, ~colnames(.x)[2])
mps <- map(mps, ~.x[, 2, drop = TRUE]) 
names(mps) <- mp_names

mps <- map(mps, 
    ~left_join(tibble(gene = .x),
               orthologs, 
               by = c("gene" = "external_gene_name")) %>% 
      pull(mmusculus_homolog_associated_gene_name) %>% 
      na.omit())

ssh_mps <- mps[str_subset(names(mps), "SHH")]
for (i in seq_along(ssh_mps)){
  so <- AddModuleScore(so, 
                       features = list(c(ssh_mps[[i]])),
                       ctrl = 50,
                       name = str_c( names(ssh_mps)[i], "_metafactor"),
                       seed = 42)
}


shh_mps <- c(
  "SHH-A_metafactor1",
  "SHH-B_metafactor1",
  "SHH-C_metafactor1"
)
names(shh_mps) <- paste0("Hovestadt_et_al_", "SHH-",
                         c("A", "B", "C"))

plts <- imap(shh_mps,
            ~plot_feature(so, 
               .x, 
               embedding = "umap", 
               show_negative = TRUE,
               minimal_theme = TRUE) + 
              labs(title = .y))

iwalk(plts, 
    ~save_plot(file.path(fig_dir, 
                         paste0("umap_shh_by_", .y, ".pdf")),
          .x, 
          base_asp = 1))

```

```{r}
to_plot <- c(
  "orig.ident",
  "clusters",
  "cell_types",
  "Phase"
)
names(to_plot) <- to_plot

plts <- imap(to_plot,
            ~plot_feature(so, 
               .x, 
               embedding = "umap"))

iwalk(plts, 
    ~save_plot(file.path(fig_dir, 
                         paste0("umap_shh_by_", .y, ".pdf")),
          .x, 
          base_asp = 1.4))


to_plot <- c(
  "Sox2",
  "Olig1",
  "Olig2",
  "Prom1"
)

names(to_plot) <- to_plot

plts <- imap(to_plot, 
    ~plot_umap(so, .x, minimal_theme = TRUE) + 
      labs(title = .y))


iwalk(plts, 
    ~save_plot(file.path(fig_dir, 
                         paste0("umap_shh_by_", .y, ".pdf")),
          .x, 
          base_asp = 1))



```

## Add our cluster modules

Using top marker genes found in our SHH human clusters, assign scores to mouse model. 

```{r}
human_markers <- read_tsv(file.path("markers",
                                   "harmony_markers_shh.tsv"))

# top 50 marker genes for modules and get mouse ortholog
human_modules <- filter(human_markers, p_val_adj < 0.05) %>% 
  group_by(cluster) %>% 
  arrange(p_val_adj, pct.1, .by_group = TRUE) %>% 
  left_join(orthologs, by = c("gene" = "external_gene_name")) %>% 
  na.omit() %>% 
  group_by(cluster) %>% 
  slice(1:50) %>% 
  split(., .$cluster) %>% 
  map(., ~pull(.x, mmusculus_homolog_associated_gene_name))

# dont't name anything with "luster" or "ouvain", as will not
# be recognized as float by ucsc cellbrowser...

names(human_modules) <- paste0("SHH_human_signatures_clust_",
                               unique(human_markers$cluster))

so <- AddModuleScore(so, 
                       features = human_modules,
                       ctrl = 50,
                       name = "tmp_",
                       seed = 42)

new_cols <- paste0("tmp_", 1:length(unique(human_markers$cluster)))
new_col_idx <- map_int(new_cols, ~which(.x == colnames(so@meta.data)))
better_cols <- names(human_modules)

# fix column names
colnames(so@meta.data)[new_col_idx] <- better_cols

names(better_cols) <- better_cols

plt <- imap(better_cols, 
    ~plot_umap(so, .x, show_negative = TRUE, minimal_theme = TRUE) + 
      labs(title = .y)) %>% 
  plot_grid(plotlist = ., 
            nrow = 3,
            ncol = 3)

plt 

save_plot(file.path(fig_dir, "umap_shh_by_SHH_human_signatures.pdf"),
          plt, 
          base_asp = 1,
          nrow = 3,
          ncol = 3)

```

## resave object

```{r}
saveRDS(so, file.path("objects",
                  "mouse_models",
                  "shh_model_sobj.rds"))
```

# GP mouse model

>
For the mouse samples
MP control and MP luc-GFP are similar and both from MP (MYC + DNP53 expression in CD133+ cells) tumor models expressing luciferase. (DN= dominant negative p53)
MG CD2 luc is the second model (MYC + GFI1 expression in CD133+ cells).
>

10.1016/j.ccr.2011.12.021

## Preprocess

```{r get_data}
samples <- c(
  "1_Mpcont",
  "2_MP_luc_GFP",
  "3_MG"
)

sample_paths <- file.path(data_dir,
                          samples,
                          "outs", 
                          "filtered_feature_bc_matrix")

names(sample_paths) <- samples

mat <- Read10X(sample_paths)
```


### General QC for library prep  {.tabset}

```{r }

metrics_paths <- file.path(data_dir,
                          samples,
                          "outs", 
                          "metrics_summary.csv")

names(metrics_paths) <- samples

mapping_dat <- map_dfr(metrics_paths, read_csv, .id = "sample")

clean_up_metadata <- function(metrics_summary) {
  metrics_summary <- mutate_all(metrics_summary, str_remove, "%$")
  metrics_summary <- mutate_at(metrics_summary, 
                               .vars = 2:ncol(metrics_summary),
                               as.numeric)
  metrics_summary
}

mapping_dat <- clean_up_metadata(mapping_dat)

metrics <- colnames(mapping_dat)[2:ncol(mapping_dat)]

mapping_dat <- mapping_dat %>% 
  gather(metric, value, -sample) %>% 
  mutate(sample = factor(sample, levels = unique(sample)))

p <- map(metrics, 
    function(x) {
    filter(mapping_dat, metric == x) %>% 
          ggplot(aes(sample, value)) +
            geom_point(aes(color = sample)) +
        scale_color_brewer(palette = "Paired") + 
        labs(y = x, 
             x = "") +
        theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
}) 
```

```{r, results ='asis'}

for(i in seq_along(p)){
  cat('\n### ', metrics[i], '\n')
  print(p[i])
  cat('\n')
}
```


## Preprocessing {.tabset}

```{r create_seurat, message = F, results = 'hide', warning = F}

so <- CreateSeuratObject(
  mat,
  min.cells = 3,
  min.features = 200,
  names.delim = "_",
  names.field = c(1, 2)
)

so <- PercentageFeatureSet(so, 
                           pattern = "^mt-", 
                           col.name = "percent.mt")

so@meta.data <- so@meta.data %>% 
  tibble::rownames_to_column("cell") %>% 
  mutate(UPN = orig.ident) %>% 
  as.data.frame() %>% 
  tibble::column_to_rownames("cell")

dir.create(file.path("objects",
                     "mouse_models"),
           showWarnings = FALSE)

# add in new sample label

new_expt_labels <- c(
  "2_MP" = "MYC + DNP53",
  "3_MG" = "MYC + GFI1"
)

so@meta.data$expt_ids <- new_expt_labels[as.character(so@meta.data$orig.ident)]

rm(mat)
a <- gc()
```

### Percent Mitochondrial UMIs 

```{r}
plot_violin(so@meta.data, "orig.ident", "percent.mt", .fill = "orig.ident") +
  labs(x = "", y = "Percent UMIs from Mitochondria")
```


### # of genes detected 

```{r}
plot_violin(so@meta.data, "orig.ident", "nFeature_RNA", .fill = "orig.ident") +
  labs(x = "", y = "# of genes per cell")
```


### # of UMIs detected

```{r}
plot_violin(so@meta.data, "orig.ident", "nCount_RNA", .fill = "orig.ident") +
  labs(x = "", y = "# of UMIs") 
```

### Table of mitochondrial proportions per sample

```{r}
so@meta.data %>% 
  group_by(UPN) %>% 
  summarize(median_percent_mito = median(percent.mt), 
            mean_percent_mito = mean(percent.mt)) %>% 
  arrange(desc(median_percent_mito))

```


## Relationship between UMIs and % mitochondria {.tabset}

### All samples
```{r, fig.width = 12, fig.height = 8}
sample_names <- as.character(unique(so@meta.data$orig.ident))
per_sample <- map(sample_names, ~filter(so@meta.data, 
                                        orig.ident == .x))
p <- list()
for(i in seq_along(per_sample)){
  .col <- discrete_palette_default[i]
  p[[i]] <- ggplot(per_sample[[i]], aes(nCount_RNA, percent.mt)) +
        geom_point(aes(color = UPN)) +
        scale_color_manual(values = .col)
}

plot_grid(plotlist= p, nrow = 1, ncol = 3)
```

```{r, results ='asis'}

for(i in seq_along(per_sample)){
  .col <- discrete_palette_default[i]
  cat('\n### ', sample_names[i], '\n')
  p <- ggplot(per_sample[[i]], aes(nCount_RNA, percent.mt)) +
        geom_point(aes(color = UPN)) +
        scale_color_manual(values = .col)
  print(p)
  cat('\n')
}
```


## Filter cells and samples.

Suggest removing cells with > 20% mitochondrial UMIs. Also remove sample `1_Mpcont` which has very few cells 

```{r}
so <- subset(so, subset = percent.mt < 20)
so <- subset(so, subset = orig.ident != "1_Mpcont")
```

## Normalize and embed into 2D with UMAP

```{r}
so <- NormalizeData(so, verbose = FALSE)

so <- FindVariableFeatures(so, 
                           selection.method = "vst", 
                           nfeatures = 3000, 
                           verbose = FALSE)

so <- ScaleData(so, 
                #vars.to.regress = c("percent.mt", "nCount_RNA"), 
                verbose = TRUE)

so <- RunPCA(so, npcs = 40, verbose = FALSE)

ElbowPlot(so, ndims = 40)

so <- FindNeighbors(so, 
                    reduction = "pca", 
                    dims = 1:30)

so <- RunUMAP(so, 
              graph = "RNA_snn", 
              min.dist = 0.3
)

plts <- list()
plts[[1]] <- plot_feature(so, "orig.ident", embedding = "umap") 
plts[[2]] <- plot_features_split(so, 
                                 "expt_ids", "expt_ids", 
                                 embedding = "umap",
                                 cols = discrete_palette_default)
plts

```

```{r}
so <- FindClusters(so, resolution = 0.32)

so$clusters<- so$seurat_clusters
so$seurat_clusters <- NULL
so$RNA_snn_res.0.32 <- NULL

plts <- list()
plts[[1]] <- plot_feature(so, "clusters", embedding = "umap") + labs(title = "All samples")
plts[[2]] <- plot_features_split(so, "clusters", 
                                 "expt_ids", embedding = "umap", add_title = TRUE)

plts
```

Add cell cycle stage

```{r, fig.width = 12}
s_genes_mouse <- inner_join(tibble(gene = cc.genes$s.genes),
                            orthologs, 
                            by = c("gene" = "external_gene_name")) %>% pull(mmusculus_homolog_associated_gene_name)

g2m_genes_mouse <- inner_join(tibble(gene = cc.genes$s.genes),
                            orthologs, 
                            by = c("gene" = "external_gene_name")) %>% pull(mmusculus_homolog_associated_gene_name)

so <- CellCycleScoring(so,
                       s_genes_mouse,
                       g2m_genes_mouse)

cc_scores <- c(
  "Pola1",
  "Mcm2",
  "Mki67",
  "Phase",
  "S.Score",
  "G2M.Score"
)

plts <- map(cc_scores,
            ~plot_umap(so, 
                       .x, 
                       show_negative = TRUE))
plt <- plot_grid(plotlist = plts, nrow = 2,
                 ncol = 3)
plt




to_plot <- c("expt_ids", "Phase", "clusters")
names(to_plot) <- c("expt_ids", "Phase", "clusters")

plts <- imap(to_plot, 
    ~plot_umap(so, .x,
              minimal_theme = TRUE) + 
              labs(title = .y))  


iwalk(plts, 
    ~save_plot(file.path(fig_dir, 
                         paste0("umap_gp34_by_", .y, ".pdf")),
          .x, 
          base_asp = 1))
```


Assign cell_types with clustifyr

```{r}
tm_average <- readRDS("/Users/kriemo/Projects/sc_repos/vanotterloo/data/tabula_muris/TM_avg_expr.rds")

mdata <- get_metadata(so)

res <- clustify(so@assays$RNA@data, 
                tm_average, 
                query_genes = so@assays$RNA@var.features,
                metadata = mdata, 
                cluster_col = "clusters", 
                compute_method = "spearman")

hmap <- Heatmap(t(res), 
                viridis::viridis(256), 
                "Spearman\ncorrelation",
                row_title = "Cell types from Tabula Muris",
                column_title = "Clusters")

hmap

top_cell_types <- cor_to_call(res, threshold = 0.5)

so@meta.data <- so@meta.data %>% 
  tibble::rownames_to_column("cell") %>% 
  left_join(top_cell_types, 
            by = c("clusters" = "cluster")) %>% 
  dplyr::rename(tabula_muris_cell_type = type,
                cor_value = r) %>% 
  tibble::column_to_rownames("cell")
```

```{r}
map(c("clusters", "tabula_muris_cell_type"), 
    ~plot_umap(so, .x, label_text = TRUE, 
               label_col = "black")) 
```


### Annotate with gfp/luc reads

```{r count_gfp}
count_transgenes <- function(sam_path, cb_prefix = "") {
  sam_lines <- read_lines(sam_path) %>%
    .[!str_detect(., "^@")] %>%
    str_split(., "\t")
  
  
  alignment_lines <- map_dfr(sam_lines,
                             function(x) {
                               read_info <- str_remove(x[1], "_$")
                               read_info <-
                                 str_split(read_info, "_")[[1]]
                               
                               if (length(read_info) == 3) {
                                 read <- read_info[1]
                                 cb <- read_info[2]
                                 umi <- read_info[3]
                               } else{
                                 read <- read_info[1]
                                 cb <- NA
                                 umi <- NA
                               }
                               
                               contig <- x[3]
                               flag <- x[2]
                               tibble(read, cb, umi, contig, flag)
                             }) %>%
    na.omit() %>%
    filter(flag == 0)
  
  
  res <- group_by(alignment_lines, cb, umi, contig) %>%
    summarize(n()) %>%
    group_by(cb, contig) %>%
    summarize(n_umi = n()) %>% 
    ungroup()
  # fix cell barcode ids
  
  res <- mutate(res, 
                cb = str_remove(cb, "^CB:Z:"),
                cb = str_remove(cb, "-[0-9]$"),
                cb = str_c(cb_prefix, cb))
  
  res <- spread(res, contig, n_umi, fill = 0L)
  res
}

sample_paths <- file.path(data_dir,
                          samples,
                          "outs",
                          "tg.sam")

tg_counts <- map2_dfr(sample_paths, str_c(samples, "_"), count_transgenes) %>% 
  mutate_if(is.numeric, log1p)

so@meta.data <- so@meta.data %>% 
  rownames_to_column("cb") %>% 
  left_join(tg_counts, by = "cb") %>%
  mutate(egfp = ifelse(is.na(egfp),
                       0L,
                       egfp),
         `luc-firefly` = ifelse(is.na(`luc-firefly`),
                       0L,
                       `luc-firefly`)) %>% 
  column_to_rownames("cb") 

to_plot <- c("egfp", "luc-firefly")
names(to_plot) <- c("egfp", "luc-firefly")

plts <- imap(to_plot, 
    ~plot_umap(so, .x))  


iwalk(plts, 
    ~save_plot(file.path(fig_dir, 
                         paste0("umap_gp34_by_", .y, ".pdf")),
          .x, 
          base_asp = 1.2))

```



#### Get markers

```{r}
saveRDS(so,
        file.path("objects",
                  "mouse_models",
                  "mb_models_sobj.rds"))
```

```{r}
so <- readRDS( file.path("objects",
                  "mouse_models",
                  "mb_models_sobj.rds"))
Idents(so) <- "clusters"
mkrs <- FindAllMarkers(so, only.pos = TRUE)

write_tsv(mkrs, 
          file.path(mkrs_tsv_dir, "mb_models_cluster_markers.tsv"))

mkrs_list <- split(mkrs, mkrs$cluster)

write.xlsx(mkrs_list, 
           file.path(mkrs_xlsx_dr,
                     "mb_models_cluster_markers.xlsx"))
```





### fix cell type assignments


```{r}
new_ids <- c(
  '5' = "monocytes",
  '9' = "CTLA4+ t-cells",
  '11' = "endothelial",
  '0' = 'malignant',
  '1' = 'malignant',
  '2' = 'malignant',
  '3' = 'malignant',
  '4' = 'neuroendocrine-malignant', # also expresses luc-firefly
  '6' = 'malignant',
  '7' = 'malignant',
  '8' = 'malignant',
  '10' = 'malignant'
  )


so@meta.data$cell_types <- new_ids[as.character(so@meta.data$clusters)]

map(c("clusters", "cell_types"), 
    ~plot_umap(so, .x, label_text = TRUE, 
               label_col = "black")) 



to_plot <- c("cell_types", "clusters", "expt_ids")
names(to_plot) <- c("cell_types", "clusters", "expt_ids")

plts <- imap(to_plot, 
    ~plot_umap(so, .x))  


iwalk(plts, 
    ~save_plot(file.path(fig_dir, 
                         paste0("umap_gp34_by_", .y, ".pdf")),
          .x, 
          base_asp = 1.4))

to_plot <- c(
  "Nrl",
  "Eomes",
  "Myc"
)

names(to_plot) <- to_plot

plts <- imap(to_plot, 
    ~plot_umap(so, .x, minimal_theme = TRUE) + 
      labs(title = .y))


iwalk(plts, 
    ~save_plot(file.path(fig_dir, 
                         paste0("umap_gp34_by_", .y, ".pdf")),
          .x, 
          base_asp = 1))

```

### Write out metadata


```{r} 
mdata_out <- get_metadata(so)
outname <- file.path("tables", 
                     paste0("mb_models_metadata_", 
                            format(Sys.Date(), "%Y_%m_%d"), 
                            ".tsv.gz"))
write_tsv(mdata_out, outname)

saveRDS(so,
        file.path("objects",
                  "mouse_models",
                  "mb_models_sobj.rds"))
```

## Add in Northcutt paper metamodule scores

```{r}
so <- readRDS(file.path("objects",
                  "mouse_models",
                  "mb_models_sobj.rds"))

if(!file.exists("../docs/northcutt_sup_tbl_2.xlsx")){
  supp_tbl_2 <- "https://static-content.springer.com/esm/art%3A10.1038%2Fs41586-019-1434-6/MediaObjects/41586_2019_1434_MOESM3_ESM.xlsx"

  download.file(supp_tbl_2, "../docs/northcutt_sup_tbl_2.xlsx")
}

sup_tbl <- read_excel("../docs/northcutt_sup_tbl_2.xlsx", 
           sheet = 2,
           skip = 3) 

sup_tbl[, 1] <- NULL

# extract out each metaprogram following their approach of excluding ribosomal
# and protein genes and non-coding RNAs

mps <- map(seq(1, ncol(sup_tbl), 2), 
    ~c(.x, .x + 1)) %>% 
  map(., ~sup_tbl[, .x] 
      %>% na.omit()) 

mp_names <- map_chr(mps, ~colnames(.x)[2])
mps <- map(mps, ~.x[, 2, drop = TRUE]) 
names(mps) <- mp_names

mps <- map(mps, 
    ~left_join(tibble(gene = .x),
               orthologs, 
               by = c("gene" = "external_gene_name")) %>% 
      pull(mmusculus_homolog_associated_gene_name) %>% 
      na.omit())

gp34_mps <- mps[str_subset(names(mps), "Group")]
for (i in seq_along(gp34_mps)){
  so <- AddModuleScore(so, 
                       features = list(c(gp34_mps[[i]])),
                       ctrl = 50,
                       name = str_c( names(gp34_mps)[i], "_metafactor"),
                       seed = 42)
}

gp34_mps <- c(
  "Group 3/4-A_metafactor1",
  "Group 3/4-B_metafactor1",
  "Group 3/4-C_metafactor1"
)

names(gp34_mps) <- paste0("Hovestadt_et_al_", "Group 3 and 4-", c("A", "B", "C"))

plts <- imap(gp34_mps,
            ~plot_feature(so, 
               .x, 
               embedding = "umap", 
               show_negative = TRUE,
               minimal_theme = TRUE) + 
              labs(title = .y))

iwalk(plts, 
    ~save_plot(file.path(fig_dir, 
                         paste0("umap_gp34_by_", .y, ".pdf")),
          .x, 
          base_asp = 1))

```

## Add our cluster modules

Using top marker genes found in our SHH human clusters, assign scores to mouse model. 

```{r}
human_markers <- read_tsv(file.path("markers",
                                   "harmony_markers_gp34.tsv"))

# top 50 marker genes for modules and get mouse ortholog
human_modules <- filter(human_markers, p_val_adj < 0.05) %>% 
  group_by(cluster) %>% 
  arrange(p_val_adj, pct.1, .by_group = TRUE) %>% 
  left_join(orthologs, by = c("gene" = "external_gene_name")) %>% 
  na.omit() %>% 
  group_by(cluster) %>% 
  slice(1:50) %>% 
  split(., .$cluster) %>% 
  map(., ~pull(.x, mmusculus_homolog_associated_gene_name))

names(human_modules) <- paste0("gp34_human_signatures_clust_",
                               unique(human_markers$cluster))

so <- AddModuleScore(so, 
                       features = human_modules,
                       ctrl = 50,
                       name = "tmp_",
                       seed = 42)

new_cols <- paste0("tmp_", 1:length(unique(human_markers$cluster)))
new_col_idx <- map_int(new_cols,
                       ~which(.x == colnames(so@meta.data)))
better_cols <- names(human_modules)

# fix column names
colnames(so@meta.data)[new_col_idx] <- better_cols

names(better_cols) <- better_cols

plt <- imap(better_cols, 
    ~plot_umap(so, .x, show_negative = TRUE, minimal_theme = TRUE) + 
      labs(title = .y)) %>% 
  plot_grid(plotlist = ., 
            nrow = 3,
            ncol = 3)


save_plot(file.path(fig_dir,
                    "umap_gp34_by_gp34_human_signatures.pdf"),
          plt, 
          base_asp = 1,
          nrow = 3,
          ncol = 3)
plt
```


## resave object

```{r}
saveRDS(so, file.path("objects",
                  "mouse_models",
                  "mb_models_sobj.rds"))
```

# Combine datasets 


```{r}
so <- readRDS(file.path("objects", "mouse_models", "mb_models_sobj.rds"))
so2 <- readRDS(file.path("objects", "mouse_models", "shh_model_sobj.rds"))


so <- merge(so, so2)

so <- NormalizeData(so, verbose = FALSE)

so <- FindVariableFeatures(so, 
                           selection.method = "vst", 
                           nfeatures = 3000, 
                           verbose = FALSE)

so <- ScaleData(so, 
                #vars.to.regress = c("percent.mt", "nCount_RNA"), 
                verbose = TRUE)

so <- RunPCA(so, npcs = 40, verbose = FALSE)

ElbowPlot(so, ndims = 40)

so <- FindNeighbors(so, 
                    reduction = "pca", 
                    dims = 1:30)

so <- RunUMAP(so, 
              graph = "RNA_snn", 
              min.dist = 0.3
)


plts <- list()
plts[[1]] <- plot_umap(so, "orig.ident") + labs(title = "All samples")
plts[[2]] <- plot_umap(so, "cell_types") + labs(title = "All samples")
plts[3:8] <- plot_features_split(so, "cell_types", "orig.ident", embedding = "umap", add_title = TRUE)

p <- plot_grid(plotlist = plts, nrow = 2, ncol = 4)
p


saveRDS(so, file.path("objects", "mouse_models", "combined.rds"))
```

```{r}
so_m <- readRDS(file.path("objects", "mouse_models", "combined.rds"))


to_plot <- c(
  "orig.ident",
  "cell_types"
)
plt <- map(to_plot,
            ~plot_umap(so_m, .x)) %>% 
  plot_grid(plotlist = ., nrow = 1, ncol = 2,
            rel_widths = c(1, 1.2))

outdir <- "figs/mouse_models"
dir.create(outdir, showWarnings = FALSE)

save_plot(file.path(outdir, "umap_overview.pdf"),
          plt,
          nrow = 1, ncol = 2, base_asp = 1.2)


```


# Determine how well the mouse models aligns with human MB



Do some data wranging to generate seurat objects with 1-to-1 mouse and human orthologs named with Human gene ids. 


```{r load_dat}
so_h <- readRDS(file.path("objects", "so.rds"))
so_m <- readRDS(file.path("objects", "mouse_models", "combined.rds"))

# subset human model to malignant cells
malignant_cells <- colnames(so_h)[so_h$coarse_cell_type == "malignant"]
so_h <- so_h[, malignant_cells]

# subset mouse model to malignant cells
malignant_cells <- colnames(so_m)[so_m$cell_types == "malignant"]
so_m <- so_m[, malignant_cells]

# use shared genes based on ortholog table

# get 1-to-1 orthologs
orthologs <- orthologs %>% 
  na.omit() %>% 
  group_by(external_gene_name) %>% 
  mutate(n_mouse_orthologs = n()) %>%
  ungroup() %>% 
  group_by(mmusculus_homolog_associated_gene_name) %>% 
  mutate(n_human_orthologs = n()) %>% 
  ungroup() %>% 
  filter(n_mouse_orthologs == 1,
         n_human_orthologs == 1)

count_mat <- so_m@assays$RNA@counts
norm_mat <- so_m@assays$RNA@data

new_gids <- left_join(tibble(genes = rownames(count_mat)),
                      orthologs, 
                      by = c("genes" = "mmusculus_homolog_associated_gene_name"))
  

genes_to_keep <- which(!is.na(new_gids$external_gene_name))

count_mat <- count_mat[genes_to_keep, ]
norm_mat <- norm_mat[genes_to_keep, ]

rownames(count_mat) <-new_gids$external_gene_name[genes_to_keep]
rownames(norm_mat) <- new_gids$external_gene_name[genes_to_keep]

so_m <- CreateSeuratObject(count_mat, 
                   meta.data = so_m@meta.data)

so_m <- SetAssayData(so_m, "data", new.data = norm_mat)

shared_ids <- intersect(rownames(so_m), rownames(so_h))

so_m <- so_m[shared_ids, ]
so_h <- so_h[shared_ids, ]

so_m$subgroup <- "mouse_model"
so_m$species <- "mouse"
so_h$species <- "human"

sos <- list(mouse_mb = so_m, human_mb = so_h)
```


```{r}
for (i in 1:length(sos)) {
    sos[[i]] <- NormalizeData(sos[[i]], verbose = FALSE)
    sos[[i]] <- FindVariableFeatures(sos[[i]], selection.method = "vst", 
        nfeatures = 2000, verbose = FALSE)
}

features <- SelectIntegrationFeatures(sos)

sos <- lapply(sos, FUN = function(x) {
    x <- ScaleData(x, features = features, verbose = FALSE)
    x <- RunPCA(x, features = features, verbose = FALSE)
})

```

Trying using reciprocal PCA approach for dataset integeration using develop version of seurat. 

```{r}
anchors <- FindIntegrationAnchors(sos, 
                                  reduction = "rpca", 
                                  dims = 1:30)

sos_integrated <- IntegrateData(anchors, 
                                dims = 1:30)
```


```{r}
sos_integrated <- ScaleData(sos_integrated, verbose = FALSE)
sos_integrated <- RunPCA(sos_integrated, verbose = FALSE)
sos_integrated <- RunUMAP(sos_integrated, dims = 1:30)

DimPlot(sos_integrated, group.by = "orig.ident")

sos_integrated$tumor_type <- ifelse(sos_integrated$species == "mouse",
                                    str_c("mouse_", sos_integrated$orig.ident),
                                    str_c("human_", sos_integrated$subgroup, "_", sos_integrated$UPN))

DimPlot(sos_integrated, group.by = "tumor_type")

Idents(sos_integrated) <- "tumor_type"
sos_integrated <- BuildClusterTree(sos_integrated, dims = 1:30)

PlotClusterTree(sos_integrated)
saveRDS(sos_integrated, "objects/mouse_models/mouse_human_int.rds")
```


```{r}
so_int <- readRDS("objects/mouse_models/mouse_human_int.rds")
DimPlot(so_int, group.by = "tumor_type")

plt <- plot_umap(so_int, "tumor_type")

save_plot("figs/mouse_models/mouse_model_with_human_integrated.pdf", 
          plt, 
          base_asp = 1.5)

Idents(so_int) <- "tumor_type"
so_int <- BuildClusterTree(so_int, dims = 1:30)

avg_expr_tt <- AverageExpression(so_int)

library(ComplexHeatmap)
Heatmap(cor(avg_expr_tt$RNA))

PlotClusterTree(so_int)


so_int$tumor_type_id <- ifelse(so_int$species == "mouse",
                                    str_c("mouse_", so_int$orig.ident),
                                    str_c("human_", so_int$subgroup, "_", so_int$UPN))

Idents(so_int) <- "tumor_type_id"
so_int <- BuildClusterTree(so_int, assay = "RNA")

PlotClusterTree(so_int,
                     show.node.label = FALSE, 
                     show.tip.label = TRUE)


avg_expr <- AverageExpression(so_int)

library(ComplexHeatmap)
Heatmap(cor(avg_expr$RNA))
```
Just merge without integration and plot

```{r}
so_merged <- merge(sos$human_mb, sos$mouse_mb, merge.data = FALSE)
so_merged <- NormalizeData(so_merged, verbose = FALSE)
so_merged <-
    FindVariableFeatures(
        so_merged,
        selection.method = "vst",
        nfeatures = 2000,
        verbose = FALSE
    )
so_merged <-
    ScaleData(so_merged,
              features = VariableFeatures(so_merged),
              verbose = FALSE)
so_merged <-
    RunPCA(so_merged,
           features = VariableFeatures(so_merged),
           verbose = FALSE)
so_merged <- RunUMAP(so_merged, dims = 1:30)

DimPlot(so_merged, group.by = "subgroup")

plt <- plot_umap(so_merged, "subgroup")

save_plot("figs/mouse_models/mouse_model_with_human.pdf", plt, base_asp = 1.5)
```

