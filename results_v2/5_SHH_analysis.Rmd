---
title: "SHH analysis"
author: "Kent Riemondy RBI"
date: "9/26/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libs, message=FALSE, warning=FALSE, echo=FALSE}
source("../R/utils.R")
library(future)

plan("multicore", workers = 7)
options(future.globals.maxSize = 2 * 1024 ^ 3)

proj_dir <- here()
data_dir <- file.path(proj_dir, "data", "cellranger", "results")
doc_dir <- file.path(proj_dir, "docs")

fig_dir <- "figs"
mkrs_dir <- "markers"
tbls_dir <- "tables"
xcel_dir <- file.path(mkrs_dir, "xlsx")
walk(c(fig_dir, mkrs_dir, tbls_dir, xcel_dir), 
     dir.create, 
     showWarnings = F)
```



```{r}
so <- readRDS(file.path("objects", "all_neoplastic.rds"))
```


```{r}
shh_cells <- colnames(so)[so$subgroup =="SHH"]

so <- so[, shh_cells]

so <- FindVariableFeatures(
  so,
  selection.method = "vst",
  nfeatures = 3000,
  verbose = FALSE
)

so <- ScaleData(so, features = VariableFeatures(so), 
                  vars.to.regress = c("percent.mt", "nCount_RNA"), 
                  verbose = TRUE)

so <- RunPCA(so, 
             features = VariableFeatures(so),
             npcs = 100, 
             verbose = FALSE)

ElbowPlot(so, ndims = 100)

# make graphs and use graphs for UMAP
so <- FindNeighbors(so, 
                      reduction = "pca", 
                      dims = 1:50, 
                      k.param = 50L)


so <- RunUMAP(so, 
              dims = 1:50, 
              n.neighbors = 30L,
              min.dist = 0.4)

so <- FindClusters(so, 
                   resolution = c(0.1, 0.3, 0.5))

so$coarse_clusters_shh <- so$RNA_snn_res.0.1

Idents(so) <- "coarse_clusters_shh"

plot_umap(so, "coarse_clusters_shh")
plot_umap(so, "UPN")
plot_umap(so, "subtype")
```

## Harmonize

```{r}
library(harmony)
so <- RunHarmony(so,
                 "UPN", 
                 theta = 1.5,
                 plot_convergence = TRUE)

so <- RunUMAP(so, 
              reduction = "harmony", 
              dims = 1:40, 
              min.dist = 0.2,
              n.neighbors = 30L,
              reduction.name = "umap_harmony",
              reduction.key = "UMAP_Harmony_")

plot_feature(so, "UPN", embedding = "umap_harmony")
plot_umap(so, "UPN")
plot_umap(so, "subtype")

so <- FindNeighbors(so, reduction = "harmony", dims = 1:40)
so <- FindClusters(so, resolution = 0.3)




so$coarse_clusters_shh_harmony <- so$seurat_clusters
Idents(so) <- "coarse_clusters_shh_harmony"
plot_feature(so, "coarse_clusters_shh_harmony", embedding = "umap_harmony")
```

```{r}
saveRDS(so, "objects/shh.rds")
```
## Markers

```{r markers of each subgroup}
so <- readRDS("objects/shh.rds")

Idents(so) <- "coarse_clusters_shh_harmony"

mkrs <- FindAllMarkers(so, only.pos = TRUE)

write_tsv(mkrs, 
          file.path(mkrs_dir, "harmony_markers_shh.tsv"))

write_markers_xlsx(split(mkrs, mkrs$cluster),
                   file.path(xcel_dir, "harmony_markers_shh.xlsx"))
```

## Go Terms


```{r}
library(gprofiler2)
library(ggrepel)
mkrs <- read_tsv(file.path(mkrs_dir, 
                    "harmony_markers_shh.tsv")) %>% 
  filter( p_val_adj < 0.05)

mkrs_split <- split(mkrs, mkrs$cluster) %>% 
  map(~pull(.x, gene))
go_res <- gost(mkrs_split, 
               ordered_query = TRUE,
               sources = c("GO", 
                          "KEGG", 
                          "REAC", 
                          "TF"))


go_res[["result"]] %>% 
  mutate(parents = unlist(map(parents, ~str_c(.x, collapse = ",")))) %>% 
  write_tsv(., file.path(tbls_dir, "goterms_shh_clusters.tsv"))

go_res[["result"]] %>% 
  mutate(parents = unlist(map(parents, ~str_c(.x, collapse = ","))),
         source = str_replace_all(source, "[[:punct:]]", " ")) %>% 
  select(-significant) %>% 
  split(., .$query) %>% 
  openxlsx::write.xlsx(., file.path(tbls_dir, "goterms_shh_cluster.xlsx"))
```
 
## Heatmap of gene expression

```{r}
topx <- read_tsv(file.path(mkrs_dir, 
                    "harmony_markers_shh.tsv")) %>% 
  filter(p_val_adj < 0.05) %>% 
  group_by(cluster) %>% 
  arrange(p_val_adj, .by_group = TRUE) %>% 
  slice(1:10)

so <- ScaleData(so, features = rownames(so))

p <- DoHeatmap(so, 
               group.colors = discrete_palette_default,
               features = unique(topx$gene),
               group.by = "coarse_clusters_shh_harmony",
               angle = 0, 
               raster = FALSE, 
               draw.lines = TRUE)

p <- p +
  scale_fill_gradientn(colours = viridis::viridis(256),
                       name = "Expression\nZ-scores")

save_plot(file.path(fig_dir, "heatmap_markers_shh.pdf"), 
          p,
          base_width = 10,
          base_height = 12)


```

## Heatmap by TF activity

```{r}
so_tf_markers <- read_tsv("tables/shh_tf_activities.tsv")

topx <- so_tf_markers %>% 
  group_by(cluster) %>% 
  arrange(p_val_adj, .by_group = TRUE) %>% 
  slice(1:5)

DefaultAssay(so) <- "TF"
so <- ScaleData(so)

p <- DoHeatmap(so, 
               group.colors = discrete_palette_default,
        features = unique(topx$gene),
        group.by = "coarse_clusters_shh_harmony",
        angle = 0, 
        raster = FALSE, 
        draw.lines = TRUE)

p <- p +
  scale_fill_gradientn(colours = viridis::viridis(256),
                       name = "Regulon AUC\nZ-scores")

save_plot(file.path(fig_dir, "heatmap_tfs_shh.pdf"), 
          p,
          base_width = 10,
          base_height = 6)

DefaultAssay(so) <- "RNA"
```

## Add in Northcutt paper metamodule scores

```{r}
supp_tbl_2 <- "https://static-content.springer.com/esm/art%3A10.1038%2Fs41586-019-1434-6/MediaObjects/41586_2019_1434_MOESM3_ESM.xlsx"


download.file(supp_tbl_2, "../docs/northcutt_sup_tbl_2.xlsx")
sup_tbl <- read_excel("../docs/northcutt_sup_tbl_2.xlsx", 
           sheet = 2,
           skip = 3) 

sup_tbl[, 1] <- NULL

# extract out each metaprogram following their approach of excluding ribosomal
# and protein genes and non-coding RNAs

mps <- map(seq(1, ncol(sup_tbl), 2), 
    ~c(.x, .x + 1)) %>% 
  map(., ~sup_tbl[, .x] 
      %>% na.omit()) 

mp_names <- map_chr(mps, ~colnames(.x)[2])
mps <- map(mps, ~.x[, 2, drop = TRUE]) 
names(mps) <- mp_names

ssh_mps <- mps[str_subset(names(mps), "SHH")]
for (i in seq_along(ssh_mps)){
  so <- AddModuleScore(so, 
                       features = list(c(ssh_mps[[i]])),
                       ctrl = 50,
                       name = str_c( names(ssh_mps)[i], "_metafactor"),
                       seed = 42)
}

```


```{r}

so <- CellCycleScoring(so,
                      g2m.features = cc.genes$g2m.genes,
                      s.features = cc.genes$s.genes)
```


```{r}
saveRDS(so, "objects/shh.rds")
```



```{r}
so <-readRDS("objects/shh.rds")

#full count matrix
GetAssayData(so, "counts") %>% 
  as.matrix(.) %>% 
  as.data.frame() %>% 
  rownames_to_column("gene") %>% 
  write_tsv("tables/shh_count_matrix.tsv.gz")
  
# expression matrix filtered at least 25 cells express the gene
expr_mat <- GetAssayData(so, "data")
expr_mat <- expr_mat[Matrix::rowSums(expr_mat > 0) >= 25, ]

expr_mat %>% 
  as.matrix(.) %>% 
  as.data.frame() %>% 
  rownames_to_column("gene") %>% 
  write_tsv("tables/shh_expr_matrix.tsv.gz")
  
```

save loom file for paga

```{r}

# drop graphs see https://github.com/theislab/scanpy/issues/598
tmp_obj <- readRDS("objects/shh.rds")
tmp_obj@graphs <- list()
# tmp_obj@meta.data <- tmp_obj@meta.data[, c("coarse_clusters_gp34_harmony",
#                                            "orig.ident",
#                                            "subtype",
#                                            "subgroup",
#                                            "UPN")]

lfile <- as.loom(tmp_obj,
                 filename = file.path("objects", "shh.loom"),
                 verbose = TRUE,
                 overwrite = TRUE)
lfile$close_all()

rm(tmp_obj)
```
