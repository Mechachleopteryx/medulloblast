---
title: "Format UCSC cellbrowser"
author: "Kent Riemondy RBI"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Cellbrowser

Format seurat object into a cellbrowser directory suitable for html browser. 

```{r}
source("../R/utils.R")
library(tidyverse)
dir.create("cellbrowser")
so <- readRDS(file.path("objects", "so.rds"))
```

Simplify object metadata to make interpretable

```{r}
cols <- colnames(so@meta.data)
cols_to_keep <- c(
  `genes per cell` = "nFeature_RNA",
  `UMIs per cell` = "nCount_RNA",
  `percent of UMIs as mitochondria` = "percent.mt",
  `clusters` = "coarse_clusters",
  `subgroup` = "subgroup",
  `Dx` = "Dx",
  `UPN` = "UPN",
  cell_type = "coarse_cell_type")
so@meta.data <- so@meta.data[, cols_to_keep]
colnames(so@meta.data) <- names(cols_to_keep)
Idents(so) <- "clusters"

```


## Set colors

```{r}
## default palette (see ../../R/utils.R)
col_palette <- discrete_palette_default

## summarize per cluster annotations
to_map <- c("clusters",
            "subgroup",
            "UPN",
            "cell_type")
col_map <- as.list(so@meta.data[, to_map]) %>%
      map(~as.character(unique(.x)))

res <- list()

tmp <- col_palette[1:length(col_map$clusters)]
names(tmp) <- col_map$clusters
res$clusters <- tmp 

tmp <- col_palette[1:length(col_map$UPN)]
names(tmp) <- col_map$UPN
res$UPN <- tmp 
  
tmp <- col_palette[1:length(col_map$subgroup)]
names(tmp) <- col_map$subgroup
res$subgroup <- tmp 

tmp <- col_palette[1:length(col_map$cell_type)]
names(tmp) <- col_map$cell_type
res$cell_type <- tmp 

map_dfr(res, 
        ~tibble(clusterName = names(.x), 
                color = .x)) %>% 
  as.data.frame() %>% 
  write_csv("cellbrowser/alldata_colorMap.csv", col_names = F, quote_escape = "none")

```


Build cellbrowser objects. Note requires UCSC (`cellbrowser python package`[ https://cellbrowser.readthedocs.io/index.html])

```{r}
dir.create("cellbrowser/markers", recursive = TRUE)
cols <- colnames(so@meta.data)
names(cols) <- colnames(so@meta.data)
mkrs <- read_tsv("markers/coarse_cluster_markers_all_data.tsv") %>% 
  select(cluster, gene, p_val_adj, everything())

write_tsv(mkrs, "cellbrowser/markers/all_data_cluster_markers.tsv")

do.call(function(...) {ExportToCellbrowser(so, 
                    dir = file.path("cellbrowser", "medulloblastoma"),
                    dataset.name = "medulloblastoma",
                    reductions = c("umap"),
                    markers.file = "cellbrowser/markers/all_data_cluster_markers.tsv",
                    cluster.field = "clusters",
                    skip.expr.matrix = TRUE,
                    ...)}, 
        as.list(cols))

```



```{bash}
cd cellbrowser
echo -e '\ncolors="/Users/kriemo/Projects/sc_repos/medulloblast/results_v2/cellbrowser/alldata_colorMap.csv"' >> medulloblastoma/cellbrowser.conf
```



## Malignant clusters

```{r}
so <- readRDS(file.path("objects", "all_neoplastic.rds"))
```

Simplify object metadata to make interpretable

```{r}
cols <- colnames(so@meta.data)
cols_to_keep <- c(
  `genes per cell` = "nFeature_RNA",
  `UMIs per cell` = "nCount_RNA",
  `percent of UMIs as mitochondria` = "percent.mt",
  `clusters` = "coarse_clusters_malignant",
  `subgroup` = "subgroup",
  `subtype` = "subtype",
  `Dx` = "Dx",
  `UPN` = "UPN",
  cell_type = "coarse_cell_type")
so@meta.data <- so@meta.data[, cols_to_keep]
colnames(so@meta.data) <- names(cols_to_keep)
Idents(so) <- "subgroup"

```


## Set colors

```{r}
## default palette (see ../../R/globals.R)
col_palette <- discrete_palette_default

## summarize per cluster annotations
to_map <- c("clusters",
            "subtype",
            "UPN",
            "cell_type",
            "subgroup")
col_map <- as.list(so@meta.data[, to_map]) %>%
      map(~as.character(unique(.x)))

res <- list()

tmp <- col_palette[1:length(col_map$clusters)]
names(tmp) <- col_map$clusters
res$clusters <- tmp 

tmp <- col_palette[1:length(col_map$UPN)]
names(tmp) <- col_map$UPN
res$UPN <- tmp 
  
tmp <- col_palette[1:length(col_map$subtype)]
names(tmp) <- col_map$subtype
res$subtype <- tmp 

tmp <- col_palette[1:length(col_map$subgroup)]
names(tmp) <- col_map$subgroup
res$subgroup <- tmp 

tmp <- col_palette[1:length(col_map$cell_type)]
names(tmp) <- col_map$cell_type
res$cell_type <- tmp 


map_dfr(res, 
        ~tibble(clusterName = names(.x), 
                color = .x)) %>% 
  as.data.frame() %>% 
  write_csv("cellbrowser/malignant_colorMap.csv", col_names = F, quote_escape = "none")

```


Build cellbrowser objects. Note requires UCSC (`cellbrowser python package`[ https://cellbrowser.readthedocs.io/index.html])

```{r}
dir.create("cellbrowser/markers", recursive = TRUE)
cols <- colnames(so@meta.data)
names(cols) <- colnames(so@meta.data)
mkrs <- read_tsv("markers/subgroup_markers_neoplastic.tsv") %>% 
  select(cluster, gene, p_val_adj, everything())

write_tsv(mkrs, "cellbrowser/markers/malignant_cluster_markers.tsv")

do.call(function(...) {ExportToCellbrowser(so, 
                    dir = file.path("cellbrowser", "medulloblastoma_neoplastic"),
                    dataset.name = "medulloblastoma_neoplastic",
                    reductions = c("umap"),
                    markers.file = "cellbrowser/markers/malignant_cluster_markers.tsv",
                    cluster.field = "subgroup",
                    skip.expr.matrix = FALSE,
                    ...)}, 
        as.list(cols))

```



```{bash}
cd cellbrowser
echo -e '\ncolors="/Users/kriemo/Projects/sc_repos/medulloblast/results_v2/cellbrowser/malignant_colorMap.csv"' >> medulloblastoma_neoplastic/cellbrowser.conf
```


## Immune populations


## Malignant clusters

```{r}
sobj <- readRDS(file.path("objects", "immune_sobj.rds"))
```

Simplify object metadata to make interpretable

```{r}
cols <- colnames(sobj@meta.data)
cols_to_keep <- c(
  `genes per cell` = "nFeature_RNA",
  `UMIs per cell` = "nCount_RNA",
  `percent of UMIs as mitochondria` = "percent.mt",
  `clusters` = "RNA_snn_res.0.05",
  `subtype` = "subgroup",
  `Dx` = "Dx",
  `UPN` = "UPN",
  cell_type = "cell_type",
  cell_phenotype = "cell_phenotype")
sobj@meta.data <- sobj@meta.data[, cols_to_keep]
colnames(sobj@meta.data) <- names(cols_to_keep)
Idents(sobj) <- "clusters"

```



```{r,eval = FALSE}
outdir <- "cellbrowser"
dir.create(outdir, showWarnings = FALSE)
# write out rds files with names listed in sobjs
saveRDS(sobj,file.path(outdir, "cb.rds"))
```

## Set colors

```{r}
## default palette (see ../../R/globals.R)
col_palette <- discrete_palette_default

## summarize per cluster annotations
to_map <- c("clusters",
            "subtype",
            "UPN",
            "cell_type",
            "cell_phenotype")
col_map <- as.list(sobj@meta.data[, to_map]) %>%
      map(~as.character(unique(.x)))

res <- list()

tmp <- col_palette[1:length(col_map$clusters)]
names(tmp) <- col_map$clusters
res$clusters <- tmp 

tmp <- col_palette[1:length(col_map$UPN)]
names(tmp) <- col_map$UPN
res$UPN <- tmp 
  
tmp <- col_palette[1:length(col_map$subtype)]
names(tmp) <- col_map$subtype
res$subtype <- tmp 

tmp <- col_palette[1:length(col_map$cell_type)]
names(tmp) <- col_map$cell_type
res$cell_type <- tmp 

tmp <- col_palette[1:length(col_map$cell_phenotype)]
names(tmp) <- col_map$cell_phenotype
res$cell_phenotype <- tmp 

map_dfr(res, 
        ~tibble(clusterName = names(.x), 
                color = .x)) %>% 
  as.data.frame() %>% 
  write_csv("cellbrowser/normal_colorMap.csv", col_names = F, quote_escape = "none")

```


Build cellbrowser objects. Note requires UCSC (`cellbrowser python package`[ https://cellbrowser.readthedocs.io/index.html])

```{r}
dir.create("cellbrowser/markers", recursive = TRUE)
cols <- colnames(sobj@meta.data)
names(cols) <- colnames(sobj@meta.data)
mkrs <- read_tsv("markers/normal_immune_subset_cluster_markers_between_subgroups.tsv") %>% 
  select(cluster, gene, p_val_adj, everything()) %>% 
  mutate(cluster = str_remove(cluster, "cluster_"))

write_tsv(mkrs, "cellbrowser/markers/normal_cluster_markers.tsv")

do.call(function(...) {ExportToCellbrowser(sobj, 
                    dir = file.path("cellbrowser", "medulloblastoma_normal"),
                    dataset.name = "medulloblastoma_normal",
                    reductions = c("umap"),
                    markers.file = "cellbrowser/markers/normal_cluster_markers.tsv",
                    cluster.field = "clusters",
                    skip.expr.matrix = TRUE,
                    ...)}, 
        as.list(cols))

```



```{bash}
cd cellbrowser
echo -e '\ncolors="/Users/kriemo/Projects/sc_repos/medulloblast/results/cellbrowser/normal_colorMap.csv"' >> medulloblastoma_normal/cellbrowser.conf
```




```{bash}
cd cellbrowser
/miniconda3/bin/cbBuild \
-i medulloblastoma/cellbrowser.conf \
-i medulloblastoma_malignant/cellbrowser.conf \
-i medulloblastoma_normal/cellbrowser.conf \
-i ../mouse_model/cellbrowser/mouse_medulloblastoma/cellbrowser.conf \
-o mblast 
```